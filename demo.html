<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-weight: 700;
    }
    #controls {
      margin: 20px;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #timeline, #calendar {
      width: 90%;
      max-width: 1200px;
      min-height: 500px;
      margin: auto;
      overflow-x: auto;
    }
    .error-message {
      color: red;
      font-size: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Atostogų grafikas</h1>
  <div id="controls">
    <button onclick="filterData('all')">Metų apžvalga</button>
    <button onclick="filterData(0)">Sausis</button>
    <button onclick="filterData(1)">Vasaris</button>
    <button onclick="filterData(2)">Kovas</button>
    <button onclick="filterData(3)">Balandis</button>
    <button onclick="filterData(4)">Gegužė</button>
    <button onclick="filterData(5)">Birželis</button>
    <button onclick="filterData(6)">Liepa</button>
    <button onclick="filterData(7)">Rugpjūtis</button>
    <button onclick="filterData(8)">Rugsėjis</button>
    <button onclick="filterData(9)">Spalis</button>
    <button onclick="filterData(10)">Lapkritis</button>
    <button onclick="filterData(11)">Gruodis</button>
  </div>
  <div id="timeline"></div>
  <div id="calendar"></div>

  <script type="text/javascript">
    google.charts.load("current", { packages: ["timeline", "calendar"], language: "lt" });
    google.charts.setOnLoadCallback(loadData);

    let originalData = [];
    let dailyCounts = [];
    let dataTable;
    let chart;

    function loadData() {
      const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?output=csv';

      fetch(spreadsheetUrl)
        .then(response => response.text())
        .then(csvText => {
          dataTable = new google.visualization.DataTable();
          dataTable.addColumn({ type: 'string', id: 'Darbuotojas' });
          dataTable.addColumn({ type: 'string', id: 'Name' });
          dataTable.addColumn({ type: 'date', id: 'Pradžia' });
          dataTable.addColumn({ type: 'date', id: 'Pabaiga' });
          dataTable.addColumn({ type: 'string', role: 'tooltip' });

          const rows = csvText.split('\n').slice(1).map(row => row.split(','));
          const allDates = {};
          rows.forEach(row => {
            if (row.length >= 4) {
              const employee = row[0].trim();
              const startDate = new Date(row[1].trim());
              const endDate = new Date(row[2].trim());
              const tooltip = row[3].trim();
              if (employee && !isNaN(startDate) && !isNaN(endDate)) {
                const shortName = employee.split(' ')[0];
                dataTable.addRow([employee, shortName, startDate, endDate, tooltip]);
                originalData.push([employee, shortName, startDate, endDate, tooltip]);

                // Count daily occurrences for the calendar
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                  const dateKey = d.toISOString().split('T')[0];
                  allDates[dateKey] = (allDates[dateKey] || 0) + 1;
                }
              }
            }
          });

          dailyCounts = Object.entries(allDates).map(([date, count]) => [new Date(date), count]);

          drawChart('all');
          drawCalendar();
        })
        .catch(error => {
          document.getElementById('timeline').innerHTML = '<p class="error-message">Nepavyko įkelti duomenų. Patikrinkite duomenų šaltinį.</p>';
          console.error('Klaida įkeliant duomenis iš Google Sheets:', error);
        });
    }

    function drawChart(month) {
      chart = chart || new google.visualization.Timeline(document.getElementById('timeline'));
      const filteredData = new google.visualization.DataTable();

      filteredData.addColumn({ type: 'string', id: 'Darbuotojas' });
      filteredData.addColumn({ type: 'string', id: 'Name' });
      filteredData.addColumn({ type: 'date', id: 'Pradžia' });
      filteredData.addColumn({ type: 'date', id: 'Pabaiga' });
      filteredData.addColumn({ type: 'string', role: 'tooltip' });

      originalData.forEach(row => {
        const startDate = row[2];
        const endDate = row[3];
        if (
          month === 'all' ||
          (startDate.getMonth() <= month && endDate.getMonth() >= month)
        ) {
          filteredData.addRow(row);
        }
      });

      const options = {
        timeline: {
          groupByRowLabel: true,
          showRowLabels: true
        },
        hAxis: {
          format: 'MMM dd',
          textStyle: {
            fontSize: 12,
            bold: true
          }
        },
        tooltip: { isHtml: true }
      };

      chart.draw(filteredData, options);
    }

    function drawCalendar() {
      const calendar = new google.visualization.Calendar(document.getElementById('calendar'));
      const calendarData = new google.visualization.DataTable();
      calendarData.addColumn({ type: 'date', id: 'Date' });
      calendarData.addColumn({ type: 'number', id: 'Count' });

      calendarData.addRows(dailyCounts);

      const options = {
        title: "Atostogų Intensyvumas",
        height: 350,
        colorAxis: {
          colors: ['#ffcccc', '#ff9999', '#ff6666', '#ff3333', '#ff0000', '#cc0000', '#990000', '#660000']
        }
      };

      calendar.draw(calendarData, options);
    }

    function filterData(month) {
      drawChart(month);
    }
  </script>
</body>
</html>
