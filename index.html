<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-weight: 700;
    }
    #controls, #section-controls {
      margin: 20px;
    }
    button, select {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover, select:hover {
      background-color: #0056b3;
    }
    #timeline, #calendar {
      width: 90%;
      max-width: 1200px;
      min-height: 500px;
      margin: 20px auto;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    .error-message {
      color: red;
      font-size: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Atostogų grafikas</h1>
  <div id="section-controls">
    <label for="section-select">Pasirinkite skyrių:</label>
    <select id="section-select" onchange="changeSection(this.value)">
      <option value="PTDS">PTDS</option>
      <option value="PDS">PDS</option>
      <option value="Krizes">Krizės</option>
      <option value="Poumis">Poūmis</option>
      <option value="Umus">UPS</option>
    </select>
  </div>
  <div id="controls">
    <button onclick="filterData('all')">Metų apžvalga</button>
    <button onclick="filterData(0)">Sausis</button>
    <button onclick="filterData(1)">Vasaris</button>
    <button onclick="filterData(2)">Kovas</button>
    <button onclick="filterData(3)">Balandis</button>
    <button onclick="filterData(4)">Gegužė</button>
    <button onclick="filterData(5)">Birželis</button>
    <button onclick="filterData(6)">Liepa</button>
    <button onclick="filterData(7)">Rugpjūtis</button>
    <button onclick="filterData(8)">Rugsėjis</button>
    <button onclick="filterData(9)">Spalis</button>
    <button onclick="filterData(10)">Lapkritis</button>
    <button onclick="filterData(11)">Gruodis</button>
  </div>
  <div id="timeline"></div>
  <div id="calendar"></div>

  <script type="text/javascript">
    google.charts.load("current", { packages: ["timeline", "calendar"], language: "lt" });
    google.charts.setOnLoadCallback(() => loadData('PTDS'));

    let originalData = [];
    let dailyCounts = [];
    let dataTable;
    let chart;

    const sectionUrls = {
      PTDS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=0&single=true&output=csv',
      PDS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1629487051&single=true&output=csv',
      Krizes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1394934574&single=true&output=csv',
      Poumis: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1919414918&single=true&output=csv',
      Umus: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=780455392&single=true&output=csv'
    };

    function changeSection(section) {
      const selectedUrl = sectionUrls[section];
      if (selectedUrl) {
        loadData(section);
      } else {
        console.error('Nepavyko rasti skyriaus duomenų.');
      }
    }

    function loadData(section) {
      const spreadsheetUrl = sectionUrls[section];
      fetch(spreadsheetUrl)
        .then(response => response.text())
        .then(csvText => {
          dataTable = new google.visualization.DataTable();
          dataTable.addColumn({ type: 'string', id: 'Darbuotojas' });
          dataTable.addColumn({ type: 'date', id: 'Pradžia' });
          dataTable.addColumn({ type: 'date', id: 'Pabaiga' });

          const rows = csvText.split('\n').slice(1).map(row => row.split(','));
          const allDates = {};
          originalData = [];

          rows.forEach(row => {
            if (row.length >= 3) {
              const employee = row[0].trim();
              const startDate = new Date(row[1].trim());
              const endDate = new Date(row[2].trim());
              if (employee && !isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                const shortName = employee.split(' ')[0];
                dataTable.addRow([employee, startDate, endDate]);
                originalData.push([employee, startDate, endDate]);

                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                  const dateKey = d.toISOString().split('T')[0];
                  allDates[dateKey] = (allDates[dateKey] || 0) + 1;
                }
              } else {
                console.warn(`Invalid row skipped: ${row}`);
              }
            }
          });

          dailyCounts = Object.entries(allDates).map(([date, count]) => [new Date(date), count]);

          drawChart('all');
          drawCalendar();
        })
        .catch(error => {
          document.getElementById('timeline').innerHTML = '<p class="error-message">Nepavyko įkelti duomenų. Patikrinkite duomenų šaltinį.</p>';
          console.error('Klaida įkeliant duomenis iš Google Sheets:', error);
        });
    }

    function drawChart(month) {
      chart = chart || new google.visualization.Timeline(document.getElementById('timeline'));
      const filteredData = new google.visualization.DataTable();

      filteredData.addColumn({ type: 'string', id: 'Darbuotojas' });
      filteredData.addColumn({ type: 'date', id: 'Pradžia' });
      filteredData.addColumn({ type: 'date', id: 'Pabaiga' });

      originalData.forEach(row => {
        const startDate = row[1];
        const endDate = row[2];
        if (
          month === 'all' ||
          (startDate.getMonth() <= month && endDate.getMonth() >= month)
        ) {
          filteredData.addRow(row);
        }
      });

      const options = {
        height: Math.min(originalData.length * 50, 600),
        timeline: {
          groupByRowLabel: true,
          showRowLabels: true
        },
        hAxis: {
          format: 'MMM dd',
          textStyle: {
            fontSize: 12,
            bold: true
          }
        },
        tooltip: { isHtml: true }
      };

      chart.draw(filteredData, options);
    }

    function drawCalendar() {
      const calendar = new google.visualization.Calendar(document.getElementById('calendar'));
      const calendarData = new google.visualization.DataTable();
      calendarData.addColumn({ type: 'date', id: 'Date' });
      calendarData.addColumn({ type: 'number', id: 'Count' });

      calendarData.addRows(dailyCounts);

      const options = {
        title: "Atostogų Intensyvumas",
        height: 350,
        colorAxis: {
  minValue: 0,
  maxValue: 10,
  values: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
  colors: [
    '#FFE5B4', // 0 - šviesiai geltona
    '#FFD59E', // 1
    '#FFB86C', // 2
    '#FF8C42', // 3
    '#FF7000', // 4
    '#FF3C00', // 5
    '#CC2900', // 6
    '#992000', // 7
    '#7A1800', // 8
    '#4D0F00', // 9
    '#2E0C00'  // 10 - tamsiai juoda
  ]
},
        calendar: {
          cellSize: 15,
          yearLabel: { fontSize: 14 },
          dayOfWeekLabel: { fontSize: 10 },
          monthLabel: { fontSize: 12 }
        }
      };

      calendar.draw(calendarData, options);
    }

    function filterData(month) {
      drawChart(month);
    }
  </script>
</body>
</html>
