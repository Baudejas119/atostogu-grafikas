<script type="text/javascript">
    google.charts.load("current", { packages: ["timeline", "calendar"], language: "lt" });
    google.charts.setOnLoadCallback(() => loadData('PTDS'));

    let originalData = [];
    let dataTable;
    let chart;

    const sectionUrls = {
      PTDS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=0&single=true&output=csv',
      PDS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1629487051&single=true&output=csv',
      Krizes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1394934574&single=true&output=csv',
      Poumis: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1919414918&single=true&output=csv',
      UmusII: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=780455392&single=true&output=csv',
      UmusIII: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=1192833202&single=true&output=csv',
      Geronto: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=817893722&single=true&output=csv',
      TerapinisSkyrius: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRaaILMyXpOFmATf6QC7JnJVYwRPKOjXZkL8jOgMeZI64aulzlnk7f-cbpNmog90kmLefeLN3E3tiT/pub?gid=490659936&single=true&output=csv'
    };

    const roleColors = {
      "Vadovas": "#FF5733",
      "Psichologė vaikų": "#33FF57",
      "Psichologė": "#3357FF",
      "Psichologė - psichoterapeutė": "#FF33A6",
      "Ergoterapeutas": "#FFD700",
      "Meno terapeutė": "#8A2BE2",
      "Muzikė": "#FF4500",
      "Vyr. soc. darbuotoja": "#00CED1",
      "Socialinė darbuotoja": "#8B4513",
      "Individualios priežiūros darbuotojas": "#7FFF00",
      "Gydytojas": "#B22222",
      "Slaugytoja": "#1E90FF",
      "Registratorė": "#32CD32"
    };

    function changeSection(section) {
      loadData(section);
    }

    function loadData(section) {
      const spreadsheetUrl = sectionUrls[section];
      fetch(spreadsheetUrl)
        .then(response => response.text())
        .then(csvText => {
          dataTable = new google.visualization.DataTable();
          dataTable.addColumn({ type: 'string', id: 'Darbuotojas' });
          dataTable.addColumn({ type: 'string', id: 'Atostogų laikotarpis' });
          dataTable.addColumn({ type: 'date', id: 'Pradžia' });
          dataTable.addColumn({ type: 'date', id: 'Pabaiga' });

          const rows = csvText.split('\n').map(row => row.replace(/\r/g, '').split(',').map(cell => cell.trim()));
          originalData = [];

          rows.forEach((row, index) => {
            if (index === 0 && row[0].toLowerCase() === 'darbuotojas') {
              console.warn('Antraštės eilutė praleista:', row);
              return;
            }

            if (row.length !== 4 || !row[0] || !row[1] || !row[2]) {
              console.error(`Klaidinga eilutė (${index + 1}):`, row);
              return;
            }

            const employee = row[0];
            const startDate = new Date(row[1]);
            const endDate = new Date(row[2]);
            const role = row[3] || "Nenustatyta";

            if (employee && !isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
              const periodLabel = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
              const color = roleColors[role] || "#CCCCCC";

              dataTable.addRow([employee, periodLabel, startDate, endDate]);
              originalData.push([employee, periodLabel, startDate, endDate, color]);
            } else {
              console.error(`Netinkama duomenų reikšmė (${index + 1}):`, row);
            }
          });

          drawChart('all');
        })
        .catch(error => {
          document.getElementById('timeline').innerHTML = '<p class="error-message">Nepavyko įkelti duomenų. Patikrinkite lentelės formatą.</p>';
          console.error('Klaida įkeliant duomenis iš Google Sheets:', error);
        });
    }

    function drawChart(month) {
      chart = chart || new google.visualization.Timeline(document.getElementById('timeline'));
      const filteredData = new google.visualization.DataTable();
      filteredData.addColumn({ type: 'string', id: 'Darbuotojas' });
      filteredData.addColumn({ type: 'string', id: 'Atostogų laikotarpis' });
      filteredData.addColumn({ type: 'date', id: 'Pradžia' });
      filteredData.addColumn({ type: 'date', id: 'Pabaiga' });

      originalData.forEach(row => {
        const startDate = row[2];
        const endDate = row[3];
        if (month === 'all' || (startDate.getMonth() <= month && endDate.getMonth() >= month)) {
          filteredData.addRow(row);
        }
      });

      chart.draw(filteredData, {
        height: Math.min(originalData.length * 50, 600),
        timeline: { groupByRowLabel: true },
        colors: originalData.map(row => row[4])
      });
    }

    function filterData(month) {
      drawChart(month);
    }
</script>
